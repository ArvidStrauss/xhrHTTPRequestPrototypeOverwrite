<script>
    /** ######################## **/
    /* LHM Custom Code PROD
    /* T-Systems MMS
    /* Version: 1.0.1
    /* Updated: 2020-05-15
    /** ######################## **/

    // Adjust matomo tracking settings here
    // If you adjust the following params, you have to adjust the src of the image tag above aswell
    const MATOMO_TARGET_ID = '3';
    const MATOMO_TARGET_PHP = 'https://webstatstest.muenchen.de/matomo.php';
    const MATOMO_TARGET_JS = 'https://webstatstest.muenchen.de/matomo.js';

    const CUSTOMDIMENSION_PAGETYPE = 1
    const CUSTOMDIMENSION_PAGETITLE = 2
    const CUSTOMDIMENSION_APPTYPE = 3
    const CUSTOMDIMENSION_APPTITLE = 4
    const CUSTOMDIMENSION_CONTENTTITLE = 5
    const CUSTOMDIMENSION_PAGETYPE_EVENT = 6
    const CUSTOMDIMENSION_PAGETITLE_EVENT = 7
    const CUSTOMDIMENSION_APPTYPE_EVENT = 8
    const CUSTOMDIMENSION_APPTITLE_EVENT = 9

    const CUSTOMDIMENSION_PAGETYPE_VISIT = 10
    const CUSTOMDIMENSION_PAGETITLE_VISIT = 11
    const CUSTOMDIMENSION_APPTYPE_VISIT = 12
    const CUSTOMDIMENSION_APPTITLE_VISIT = 13
    const CUSTOMDIMENSION_CONTENTTITLE_VISIT = 14
    const CUSTOMDIMENSION_PAGETYPE_EVENT_VISIT = 15
    const CUSTOMDIMENSION_PAGETITLE_EVENT_VISIT = 16
    const CUSTOMDIMENSION_APPTYPE_EVENT_VISIT = 17
    const CUSTOMDIMENSION_APPTITLE_EVENT_VISIT = 18

    // list timeline item tracked users here with profile uri endpoint
    // posts by these users in a timeline wont be tracked (likes,comments,...)
    const EXCLUDE_TIMELINETRACKINGUSERS = []; //'ian-bold', 'robert-lang'
    const EXCLUDED_PATHS = ['/admin/']; // '/workspaces/', '/admin/'
    const EXCLUDED_GROUPINGPATHS = ['/profile/', '/account']; // '/workspaces/', '/admin/'
    const ENV = 'prod';
    const CONTENTBASE = 'wilma';
    const USE_TAGMANAGER = true;

    const SELECTORS = {
        HEAD_NAVIGATION: '.navbar-main .nav-left a',
        HEAD_SUBNAVIGATION: '.navbar-sub a',
        NAV_SIDEBAR: '.sidebar .nav-sidebar-item a',
        SIDEBAR_SUBSCRIPTIONS: 'coyo-subscription-widget a',
        SIDEBAR_BOOKMARKS: 'coyo-bookmarking-show a',
        SEARCHFILTER_TYPE: 'coyo-filter[title-key="MODULE.SEARCH.TYPE"] a',
        SEARCHFILTER_MODIFIED: 'coyo-filter[title-key="MODULE.SEARCH.MODIFIED"] a',
        SEARCHFILTER_LOCATION: 'coyo-filter[title-key="MODULE.SEARCH.LOCATION"] a',
        SEARCHFILTER_AUTHOR: 'coyo-filter[title-key="MODULE.SEARCH.AUTHOR"] a',
    }

    var extanaSettingsOverride = {
        debug: true
    };

    /** ######################## **/
    /* LHM Tracking DB Helper PROD
    /* T-Systems MMS
    /* Version: 1.0.1
    /* Updated: 2020-05-15
    /** ######################## **/

    var coyoTrackingDBHelper = {
        objects: {},
        acceptedUrlPatterns: [
            // if this is empty, all requests are analyzed
            // { 'get': /\/blog\/articles/g },
            // { 'get': /\/wiki\/articles/g },
            // { 'get': /\/web\/pages/g },
            // { 'get': /\/web\/workspaces/g },
            // { 'get': /\/web\/timeline-items/g },
            // { 'get': /\/web\/comments/g },
            // { 'get': /\/web\/users/g },
            // { 'post': /\/web\/comments/g }
        ],

        isAcceptedURL: function(url, method) {
            if (!url || !method) return false;
            return (this.acceptedUrlPatterns.length == 0) || this.acceptedUrlPatterns.some(function(pattern) {
                return pattern[method.toLowerCase()] && url.match(pattern[method.toLowerCase()]);
            });
        },

        buildAuthorMessage: function(message, authorItem) {
            message = message || '';
            message = message.length > 30 ? message.substring(0, 30).trim() + ' ...' : message;
            return authorItem ? authorItem.slug + ' >> ' + message : message;
        },

        stripHTML: function(html) {
            if (!html) return '';
            var doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || '';
        },

        buildTrackingTitle: function(item, parent) {
            if (!item) return '';
            var title = item.displayName || '';
            if (item.typeName == 'timeline-item') {
                var message = (item.data ? item.data.message : this.stripHTML(item.excerpt)) || '';
                title = this.buildAuthorMessage(message, item.author);
            } else if (item.typeName == 'comment') {
                var message = item.message || (item.data ? item.data.message : '');
                title = this.buildAuthorMessage(message, item.author);
            } else if ('user' == item.typeName) {
                title = item.slug;
            }

            return title;
        },

        checkStorageForData: function(method, responseHeader) {
            if (!responseHeader) {
                return null;
            }
            try {
                var cache = $.extend(JSON.parse(sessionStorage['ngStorage-etagBulkCache'] || null), JSON.parse(sessionStorage['coyo-etagBulkCache'] || null));
                var keys = Object.keys(cache);
                var itemID = (/"([0-9a-fA-F-]*)":/g).exec(responseHeader)[1];
                var etag = (/:"([0-9a-fA-F-]*)"/g).exec(responseHeader)[1];
                for (var i = 0; i < keys.length; i++) {
                    var item = cache[keys[i]][itemID];
                    if (this.isAcceptedURL(keys[i], method) && item && item.etag == etag) {
                        return item.data || item.body;
                    }
                };
            } catch (e) {}
            return null;
        },

        processParent: function(item) {
            // process parents of shared content 
            if (item.typeName == 'timeline-item' && item.data) {
                // shared or native timeline-item
                if (item.itemType == 'post' && item.recipients && item.recipients.length == 1) {
                    var target = item.recipients[0];
                    return {
                        id: target.id,
                        type: target.typeName,
                        name: this.buildTrackingTitle(target)
                    };
                }
                // shared content item
                for (var temp in item.data) {
                    if (item.data[temp] && item.data[temp].sender) {
                        this.setObjectData(item.data[temp].sender);
                        var object = {
                            id: item.data[temp].id,
                            parent: {
                                id: item.data[temp].sender.id,
                                typeName: item.data[temp].sender.typeName,
                                name: this.buildTrackingTitle(item.data[temp].sender)
                            }
                        }
                        this.setObjectData(object);
                    }
                }
            } else if (item.typeName == 'wiki-article' || item.typeName == 'blog-article') {
                var parent = this.objects[item.senderId];
                if (parent) {
                    return {
                        id: item.senderId,
                        type: parent.type,
                        name: parent.name
                    };
                }
            } else if (item.typeName == 'comment' && item.target) {
                var parent = this.objects[item.target.id];
                if (parent) {
                    return {
                        id: item.target.id,
                        type: parent.type,
                        name: parent.name
                    };
                }
            }
            return null;
        },

        setObjectData: function(item, nameOverride) {
            if (!item || !item.id) return;

            var recipient = item.recipients && item.recipients.length == 1 ? item.recipients[0] : null;
            var parent = this.processParent(item);

            // override old values if new ones are present
            var id = item.id;
            this.objects[id] = this.objects[id] || {
                name: '',
                type: '',
                target: {
                    id: '',
                    type: ''
                },
                author: '',
                parent: {
                    id: '',
                    type: '',
                    name: ''
                }
            };
            this.objects[id].type = item.typeName || this.objects[id].type;
            this.objects[id].target.id = recipient ? recipient.id : this.objects[id].target.id;
            this.objects[id].target.type = (recipient ? recipient.typeName : '') || this.objects[id].target.type;
            this.objects[id].author = (item.author ? item.author.slug : '') || this.objects[id].author;
            this.objects[id].parent.id = (parent ? parent.id : item.parent ? item.parent.id : '') || this.objects[id].parent.id;
            this.objects[id].parent.type = (parent ? parent.typeName : item.parent ? item.parent.typeName : '') || this.objects[id].parent.type;
            this.objects[id].parent.name = (parent ? parent.name : item.parent ? item.parent.name : '') || this.objects[id].parent.name;

            // this has to be last call because there may be dependencies to the objects parent when generating the name
            this.objects[id].name = nameOverride ? nameOverride : (this.buildTrackingTitle(item, this.objects[id].parent) || this.objects[id].name);
        },

        getObjectData: function(id) {
            return this.objects[id] || {
                name: '',
                type: '',
                target: {
                    id: '',
                    type: ''
                },
                author: '',
                parent: {
                    id: '',
                    type: '',
                    name: ''
                }
            };
        },

        populateContentData: function(content) {
            var that = this;
            if (!content || !Array.isArray(content)) return;
            content.forEach(function(item) {
                that.setObjectData(item);
            });
        },

        populateResponseData: function(response, responseURL, method) {
            if (typeof response == 'undefined' || !response || typeof response != 'object' || !this.isAcceptedURL(responseURL, method)) return;
            var that = this;
            if (response.topApps) {
                response.topApps.forEach(function(item) {
                    that.setObjectData(item, item.slug);
                });
            }
            if (response.id) {
                this.setObjectData(response);
            }

            if (response.content) {
                this.populateContentData(response.content);
            } else {
                for (var item in response) {
                    if (response[item] && response[item].content) {
                        this.populateContentData(response[item].content);
                    }
                }
            }
        },
    };

    var openPrototypeDB = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function() {
        var method = arguments[0];
        var reqURL = arguments[1];
        this.addEventListener('load', function() {
            var resp = {};
            resp.responseType = this.responseType;
            resp.responseURL = this.responseURL || reqURL;
            try {
                resp.responseText = this.responseText;
                resp.responseHeader = this.getResponseHeader('x-bulk-etag');
            } catch (e) {}
            setTimeout(function() {
                var response;
                try {
                    if ((resp.responseType == '' || resp.responseType == 'text' || resp.responseType == 'document' || resp.responseType == 'moz-chunked-text') && resp.responseText) {
                        response = eval("(" + resp.responseText + ")");
                    }
                } catch (e) {}

                if ($.isEmptyObject(response) && coyoTrackingDBHelper.isAcceptedURL(resp.responseURL, method)) {
                    response = coyoTrackingDBHelper.checkStorageForData(method, resp.responseHeader);
                }

                coyoTrackingDBHelper.populateResponseData(response, resp.responseURL, method);
            });
        }, 2);
        openPrototypeDB.apply(this, arguments);
    };

    /** ######################## **/
    /* LHM Tracking Utils PROD
    /* T-Systems MMS
    /* Version: 1.0.1
    /* Updated: 2020-05-15
    /** ######################## **/

    var coyoTrackingUtils = {
        createHashCode: function(input) {
            var hash = 0,
                i, chr;
            if (!input || input.length === 0) return hash;
            for (i = 0; i < input.length; i++) {
                chr = input.charCodeAt(i);
                hash = ((hash << 5) - hash) + chr;
                hash |= 0;
            }
            return hash;
        },
        getUserIdHash: function() {
            return '' + coyoTrackingUtils.createHashCode(localStorage.getItem('ngStorage-userId'));
        },
        cleanupCustomDimensions: function() {
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETYPE]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETITLE]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTYPE]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTITLE]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_CONTENTTITLE]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETYPE_EVENT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETITLE_EVENT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTYPE_EVENT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTITLE_EVENT]);
            //VISIT TEST
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETYPE_VISIT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETITLE_VISIT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTYPE_VISIT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTITLE_VISIT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_CONTENTTITLE_VISIT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETYPE_EVENT_VISIT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_PAGETITLE_EVENT_VISIT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTYPE_EVENT_VISIT]);
            _paq.push(['deleteCustomDimension', CUSTOMDIMENSION_APPTITLE_EVENT_VISIT]);
        },
        excludeUrl: function(url, pathArray) {
            var paths = pathArray || EXCLUDED_PATHS;
            return paths && paths.some(function(path) {
                return url && url.indexOf(location.host + path) >= 0;
            });
        },
        excludeUser: function(item) {
            var user = '';
            if (!item || !item.type) return false;

            switch (item.type) {
                case 'timeline-item':
                    user = item.author;
                    break;
                case 'user':
                    user = item.name;
                    break;
                default:
                    return false;
            }

            return EXCLUDE_TIMELINETRACKINGUSERS && EXCLUDE_TIMELINETRACKINGUSERS.some(function(item) {
                return item == user;
            });
        },
        excludeFromTracking: function(pathArray) {
            // check container of a file within the preview modal
            var fileOriginElem = document.querySelector('coyo-library-file-details .coyo-file-details dt[translate="FILE_DETAILS.FILE_ORIGIN"]');
            if (fileOriginElem) {
                try {
                    var linkElem = fileOriginElem.nextElementSibling.getElementsByTagName('a')[0];
                    var url = linkElem ? linkElem.href : null;
                    if (coyoTrackingUtils.excludeUrl(url, pathArray)) {
                        return true;
                    }
                } catch (e) {}
            }
            return coyoTrackingUtils.excludeUrl(location.href, pathArray) || coyoTrackingUtils.preventTracking;
        },
        typeNameOverrides: function(typeName, escape) {
            escape = (typeof escape === 'boolean' && escape) ? true : false;
            var overrides = {
                'pages': 'Seiten',
                'page': 'Seite',
                'home': 'Startseite',
                'workspaces': 'Arbeitsräume',
                'arbeitsraeume': 'Arbeitsräume',
                'workspace': 'Arbeitsraum',
                'blog-article': 'Blog-Artikel',
                'wiki-article': 'Wiki-Artikel',
                'chat-message': 'Chat',
                'create': 'Erstellen',
                'timeline-item': 'Timeline-Item',
                'comment': 'Kommentieren',
                'share': 'Teilen',
                'subscribe': 'Abonnieren',
                'unsubscribe': 'Deabonnieren',
                'search': 'Suche',
                'timeline': 'Timeline',
                'filelibrary': 'Dokumente',
                'file-library': 'Dokumente',
                'content': 'Content',
                'article': 'Artikel',
                // 'timeline': 'Verlauf',
                'list': 'Liste',
                'invited': 'Einladungen',
                'imprint': 'Impressum',
                // 'events': 'termine',
                'colleagues': 'Kollegen',
                'activity': 'Aktivitaeten',
                'quicksearch': 'Schnellsuche',
                // 'blog-list-view': 'Blog',
                // 'wiki-list-view': 'Wiki'
            };
            typeName = overrides[typeName.toLowerCase().trim()] || typeName;
            if (typeName && typeName.length) typeName = typeName.charAt(0).toUpperCase() + typeName.slice(1);
            if (escape) typeName = encodeURIComponent(coyoTrackingUtils.shortenString(typeName, 200));
            return typeName;
        },
        typeNameOverridesPageId: function(typeName) {
            var overrides = {
                'pages': 'seiten',
                'page': 'seite',
                'home': 'startseite',
                'workspaces': 'ar',
                'arbeitsraeume': 'ar',
                'workspace': 'ar',
                'search': 'suche',
                'filelibrary': 'dokumente'
            };
            return overrides[typeName] || typeName;
        },
        translateText: function(text) {
            return text && text.toLowerCase()
                .replace(/[\/\ \.]/g, '-')
                .replace(/\u00dc/g, 'Ue')
                .replace(/\u00fc/g, 'ue')
                .replace(/\u00c4/g, 'Ae')
                .replace(/\u00e4/g, 'ae')
                .replace(/\u00e4/g, 'ae')
                .replace(/\u00d6/g, 'Oe')
                .replace(/\u00f6/g, 'oe')
                .replace(/\u00df/g, 'ss')
                .replace(/_/g, '-')
                .replace(/(?:\r\n|\r|\n)/g, '-')
                .replace(/&/g, ' und ')
                .replace(/@/g, ' -at- ')
                .replace(/[^a-zA-Z0-9 \-\\.\/]+/g, '') //remove . after text inside a title to avoid confusion with . as separator
                .replace(/\s+/g, '-')
                .replace(/[-]{2,}/g, '-')
                .replace(/^-*/g, '') //remove all trailing '-' so we dont get '-my-shiny-title-'
                .replace(/-*$/g, '') || '';
        },
        shortenString: function(input, maxlength) {
            maxlength = maxlength || 30;
            return input.length > maxlength ? input.substring(0, maxlength).trim() + '...' : input;
        },
        toAbsoluteUrl: (function() {
            // return a function and keep elem to prevent creation 
            // of <a>-element each time this function is called
            var elem;
            return function(url) {
                elem = elem || document.createElement('a');
                elem.href = url;
                return elem.href;
            };
        })(),
        parseQueryString: function(str) {
            var query = (str || '?').substr(1);
            var map = {};
            query.replace(/([^&=]+)=?([^&]*)(?:&+|$)/g, function(match, key, value) {
                (map[key] = map[key] || []).push(value);
            });
            return map;
        },

        getPageConfig: function(override) {
            var contentGroup = [CONTENTBASE];
            var trackingTitle = '';
            override = override || {};

            var analyzePage = function(contentGroup, override) {
                var page = $('section.page div.panel.panel-default div.panel-foreground div.titles-container div.title-description-wrapper div.title').text().trim() || (location.href.split('/')[4] ? decodeURIComponent(location.href.split('/')[4]) : null);
                var navigation = $('section.page .content-sidebar .panel-navigation ul.nav.nav-default li.filter-entry.active a').text().trim() || coyoTrackingDBHelper.getObjectData(window.location.href.split('/')[7]).name;
                var bodyClass = $('body').attr('class');
                var classMatch = /state-main-page-show-apps-([\w\-]*)/g.exec(bodyClass) || /state-main-page-show-([\w\-]*)/g.exec(bodyClass) || /state-main-page-([\w\-]*)/g.exec(bodyClass);
                var app = window.location.href.split('/')[6] ? decodeURIComponent(window.location.href.split('/')[6]) : (classMatch ? classMatch[1] : '');
                // check for platform specific type name overrides
                contentGroup[1] = 'pages';
                if (page) contentGroup[2] = override[2] ? override[2] : page;
                if (app && 'create' !== app.toLowerCase()) contentGroup[3] = override[3] ? override[3] : app;
                if (navigation) contentGroup[4] = override[4] ? override[4] : navigation;
            };

            var analyzeWorkspace = function(contentGroup, override) {
                var workspace = $('section.workspace div.panel.panel-default div.panel-foreground div.titles-container div.title').text().trim() || (location.href.split('/')[4] ? decodeURIComponent(location.href.split('/')[4]) : null);
                var navigation = $('section.workspace .content-sidebar .panel-navigation ul.nav.nav-default li.filter-entry.active a').text().trim() || coyoTrackingDBHelper.getObjectData(window.location.href.split('/')[7]).name;
                var bodyClass = $('body').attr('class');
                var classMatch = /state-main-workspace-show-apps-([\w\-]*)/g.exec(bodyClass) || /state-main-workspace-show-([\w\-]*)/g.exec(bodyClass) || /state-main-workspace-([\w\-]*)/g.exec(bodyClass);
                var app = window.location.href.split('/')[6] ? decodeURIComponent(window.location.href.split('/')[6]) : (classMatch ? classMatch[1] : '');
                // check for platform specific type name overrides
                contentGroup[1] = 'workspaces';
                if (workspace) contentGroup[2] = override[2] ? override[2] : workspace;
                if (app && 'create' !== app.toLowerCase()) contentGroup[3] = override[3] ? override[3] : app;
                if (navigation) contentGroup[4] = override[4] ? override[4] : navigation;
            };

            var analyzeEvent = function(contentGroup, override) {
                var event = $('section.event div.panel.panel-default div.titles-container div.title').text().trim() || (location.href.split('/')[4] ? decodeURIComponent(location.href.split('/')[4]) : null);
                var bodyClass = $('body').attr('class');
                var classMatch = /state-main-event-show-([\w\-]*)/g.exec(bodyClass) || /state-main-event-([\w\-]*)/g.exec(bodyClass);
                var app = window.location.href.split('/')[6] ? decodeURIComponent(window.location.href.split('/')[6]) : (classMatch ? classMatch[1] : '');
                // check for platform specific type name overrides
                contentGroup[1] = 'events';
                if (event) contentGroup[2] = override[2] ? override[2] : event;
                if (app && 'create' !== app.toLowerCase()) contentGroup[3] = override[3] ? override[3] : app;
            };

            var analyzeContentTitle = function(contentGroup, override) {
                // check if the user is creating or editing sth
                var bodyClass = $('body').attr('class');
                var classMatch = /state-main-(page|workspace|event)-show-apps-([\w\-]*)/g.exec(bodyClass) ||
                    /state-main-(page|workspace|event)-show-([\w\-]*)/g.exec(bodyClass) ||
                    /state-main-(page|workspace|event)-([\w\-]*)/g.exec(bodyClass);
                var func = classMatch ? /-(create|edit)$/g.exec(classMatch[2]) : null;
                func = func ? func[1] : null;

                // cloning and stuff is needed to remove the status text from title string (open, closed, etc.)
                var threadTitle = $('.thread-view .thread-title').clone().children().remove().end().text().trim();
                // since is possible that there are multiple article titles on a page, we have to priorize them with the following statement
                var articleTitleElem = $($('.article-view .panel-title-main:first')[0] || $('.article-view .panel-title:first')[0] || $('.article-view .article-title:first')[0]);
                var articleTitle = articleTitleElem.text().trim();

                if (func && !articleTitle) {
                    articleTitle = $('form input[id*="title"]').val().trim();
                }

                var title = articleTitle || threadTitle;
                if (title) {
                    contentGroup[contentGroup.length] = override[contentGroup.length] ? override[contentGroup.length] : title;
                    trackingTitle = title + ':' + (contentGroup[2] || '');
                }
                // add 'create' or 'edit' behind the content or app title
                if (func) {
                    contentGroup[contentGroup.length] = override[contentGroup.length] ? override[contentGroup.length] : func;
                }
            }

            var analyzeFile = function(contentGroup, override) {
                var page = decodeURIComponent(location.href.split('/')[6]);
                // check for platform specific type name overrides
                contentGroup[1] = 'filelibrary';
                if (page) contentGroup[2] = override[2] ? override[2] : page;
            };

            // find the first navigation level
            var navItem = $('nav.navbar-main ul.nav li.nav-item.active a');
            if (!navItem.length) {
                navItem = $('div.sub-navigation nav.navbar ul.nav li.nav-item.active a.nav-item');
            }

            if (navItem.length && navItem.attr('href')) {
                var menuEntry = (/\/([^?\/]*)/g).exec(navItem.attr('href'));
                if (menuEntry && menuEntry.length > 1) {
                    contentGroup[1] = override[1] ? override[1] : menuEntry[1];
                }
            } else if ($('div.content section.profile').length) {
                contentGroup[1] = override[1] ? override[1] : 'profile';
            } else {
                // get the current position generically from body class
                var classMatch = (/state-main-([\w-]*)/g).exec($('body:eq(0)').attr('class'));
                if (classMatch && classMatch.length > 1) {
                    contentGroup[1] = override[1] ? override[1] : classMatch[1];
                } else if ((/state-admin/g).exec($('body:eq(0)').attr('class'))) {
                    contentGroup[1] = override[1] ? override[1] : 'admin';
                }
            }

            var contentGroupTwo = {
                'home': function() {
                    var homepage = (/\/[^\/]*\/([^?\/]*)/g).exec(navItem.attr('href'));
                    if (homepage.length > 1) {
                        contentGroup[2] = override[2] ? override[2] : homepage[1];
                    }
                },
                'pages': function() {
                    analyzePage(contentGroup, override);
                    analyzeContentTitle(contentGroup, override);
                },
                'workspaces': function() {
                    analyzeWorkspace(contentGroup, override);
                    analyzeContentTitle(contentGroup, override);
                },
                'events': function() {
                    analyzeEvent(contentGroup, override);
                },
                'profile': function() {
                    var name = $('section.profile div.panel.panel-default div.titles-container div.title').text();
                    var view = $('section.profile div.panel.panel-default div.profile-nav ul.nav li.nav-item.active').attr('href');
                    if (view && view.split('/').length > 3) {
                        contentGroup[3] = override[3] ? override[3] : view.split('/')[3];
                    }
                    contentGroup[2] = override[2] ? override[2] : name;
                },
                'timeline-item': function() {
                    var itemMatch = /\/timeline\/item\/([0-9a-fA-F-]*)/g.exec(window.location.href);
                    if (itemMatch) {
                        contentGroup[2] = override[2] ? override[2] : coyoTrackingDBHelper.getObjectData(itemMatch[1]).name;
                    }
                },
                'fileLibrary': function() {
                    analyzeFile(contentGroup, override);
                }
            };
            if (contentGroupTwo[contentGroup[1]]) {
                contentGroupTwo[contentGroup[1]]();
            }

            //remove anchor tag from pageType
            if (contentGroup[1] && contentGroup[1].indexOf('#') !== -1) {
                contentGroup[1] = contentGroup[1].substr(0, contentGroup[1].indexOf('#'));
            }

            return {
                contentGroup: contentGroup,
                trackingTitle: trackingTitle
            };
        },
        pageIdToString: function(page) {
            var result = "";
            if (page) {
                for (i = 0; i < 100; i++) {
                    if (page[i]) {
                        result += (i > 0 ? "." : "");
                        if (i > 4 && i === page.length - 1) {
                            result += coyoTrackingUtils.shortenString(coyoTrackingUtils.typeNameOverridesPageId(coyoTrackingUtils.translateText(page[i])));
                        } else {
                            result += coyoTrackingUtils.typeNameOverridesPageId(coyoTrackingUtils.translateText(page[i]));
                        }
                    } else {
                        break;
                    }
                }
            }
            return result;
        },
        getResponseHeaders: function(respObj) {
            var headers = respObj.getAllResponseHeaders().split(/\r\n/);
            var headersFormatted = {};
            for (i = 0; i < headers.length; i++) {
                var item = headers[i].split(': ');
                var name = item[0];
                var value = item[1]
                headersFormatted[name] = value;
            }
            return headersFormatted;
        },
        getVideoInfo: function(url, callback) {
            var docMatch = (/documents\/([0-9a-fA-F-]*)/g).exec(url);
            var objData = coyoTrackingDBHelper.getObjectData(docMatch[1]);
            if (objData && objData.name && objData.name.length) {
                callback(objData.name);
            } else {
                var http = new XMLHttpRequest();
                http.open('HEAD', url);
                http.onreadystatechange = function() {
                    if (this.readyState == this.DONE) {
                        var respHeader = coyoTrackingUtils.getResponseHeaders(this);
                        var filename = respHeader['content-disposition'].match(/filename=\".*(?=")/g)[0].replace('filename="', '');
                        callback(filename);
                    }
                };
                http.send();
            }
        }
    };

    /** ######################## **/
    /* LHM Tracking Code PROD
    /* T-Systems MMS
    /* Version: 1.0.1
    /* Updated: 2020-05-15
    /** ######################## **/

    var currentUrl = location.href;
    var initialStateChangeFired = false;
    var pendingSearch = 0;
    var lastFileId = '';
    // create tracking settings including overrides if present
    var pageId, pageName, pageType, preventTracking;
    var extanaSettings = Object.assign({
        system: 'coyo',
        trackStateChanges: true,
        trackCoyoStateClass: true,
        trackCoyoStateClassVisit: true,
        debug: false,
        pkInitiate: true,
        pkId: MATOMO_TARGET_ID,
        pkLibPathPHP: MATOMO_TARGET_PHP,
        pkLibPathJS: MATOMO_TARGET_JS,
        pkDomains: [location.hostname],
        pkLogUserUID: false,
        pkHashUserUID: true,
        pkActivateHeartbeat: true,
        pkHeartbeatDelay: 15,
        pkTrackMiddleRightMouseClick: true,
        pkContentTracking: true,
        pkContentTrackingDOMNode: '.content',
        pkContentTrackingScanForMedia: true,
        pkContentTrackingScanForForms: true,
        pkContentTrackingAutoRefresh: true,
        pkContentTrackingRefreshDelay: 750,
        delayForStateChange: 10,
        logAllApiCalls: false,
        logAllApiCallsEvent: ['API', 'Call']
    }, extanaSettingsOverride || {});

    var _paq = _paq || [];
    extanaSettings.pkDomains !== null ? _paq.push(['setDomains', extanaSettings.pkDomains]) : null;
    (function() {
        _paq.push(['setTrackerUrl', extanaSettings.pkLibPathPHP]);
        _paq.push(['setSiteId', extanaSettings.pkId]);
        var uid = coyoTrackingUtils.getUserIdHash();
        if (uid !== '0') _paq.push(['setUserId', uid]);
        var d = document;
        var g = d.createElement('script');
        var s = d.getElementsByTagName('script')[0];
        g.type = 'text/javascript';
        g.async = true;
        g.defer = true;
        g.src = extanaSettings.pkLibPathJS;
        s.parentNode.insertBefore(g, s);
    })();

    _paq.push(['enableHeartBeatTimer', extanaSettings.pkHeartbeatDelay || 15]);
    //disable matomo defaut downloadtracking
    _paq.push(['setDownloadExtensions', ""]);

    // Element.closest() polyfill for IE
    if (!Element.prototype.matches) {
        Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
    }
    if (!Element.prototype.closest) {
        Element.prototype.closest = function(s) {
            var el = this;
            do {
                if (el.matches(s)) return el;
                el = el.parentElement || el.parentNode;
            } while (el !== null && el.nodeType === 1);
            return null;
        };
    }

    // List of tracked requests
    var coyoRequestTrackingConfig = [
        // {
        //     urlPattern: /web\/message-channels$/g,
        //     method: 'POST',
        //     execute: function(responseUrl, response) {
        //         sendTrackingEvent('chat-channel', 'Create', response.type);
        //     }
        // }, 
        {
            urlPattern: /web\/message-channels\/[0-9a-fA-F-]*\/messages$/g,
            method: 'POST',
            execute: function(responseUrl, response) {
                sendTrackingEvent('chat-message', 'Create', '');
            }
        }, {
            urlPattern: /web\/comments/g,
            method: 'POST',
            execute: function(responseUrl, response) {
                var item = coyoTrackingDBHelper.getObjectData(response.target.id);
                sendTrackingEvent(response.target.typeName, 'Comment', item.name, item);
            }
        }, {
            urlPattern: /subscriptions$/g,
            method: 'POST',
            execute: function(responseUrl, response) {
                var item = coyoTrackingDBHelper.getObjectData(response.targetId);
                sendTrackingEvent(item.type, 'Subscribe', item.name, item);
            }
        }, {
            urlPattern: /subscriptions\/favorite/g,
            method: 'POST',
            execute: function(responseUrl, response) {
                var queryParams = coyoTrackingUtils.parseQueryString(responseUrl.replace(/.*\?/i, '?'));
                if (queryParams.targetId) {
                    var item = coyoTrackingDBHelper.getObjectData(queryParams.targetId);
                    sendTrackingEvent(item.type, 'Subscribe', item.name, item);
                }
            }
        }, {
            urlPattern: /subscriptions.*\?targetId=/g,
            method: 'DELETE',
            execute: function(responseUrl, response) {
                var targetMatch = (/targetId=([^\&]*)/g).exec(responseUrl);
                if (targetMatch && targetMatch.length > 1) {
                    var item = coyoTrackingDBHelper.getObjectData(targetMatch[1]);
                    sendTrackingEvent(item.type || 'unknown-type', 'Unsubscribe', item.name, item);
                }
            }
        }, {
            urlPattern: /web\/like-targets\//g,
            method: 'POST',
            execute: function(responseUrl, response) {
                var typeMatch = (/like-targets\/([\w-]*)\/([0-9a-fA-F-]*)/g).exec(responseUrl);
                if (typeMatch && typeMatch.length > 1) {
                    var type = typeMatch[1];
                    var item = coyoTrackingDBHelper.getObjectData(typeMatch[2]);
                    var entry = item.name || coyoTrackingUtils.getPageConfig().trackingTitle || '';
                    sendTrackingEvent(type, 'Like', entry, item);
                }
            }
        }, {
            urlPattern: /web\/like-targets\//g,
            method: 'DELETE',
            execute: function(responseUrl, response) {
                var typeMatch = (/like-targets\/([\w-]*)\/([0-9a-fA-F-]*)/g).exec(responseUrl);
                if (typeMatch && typeMatch.length > 1) {
                    var type = typeMatch[1];
                    var item = coyoTrackingDBHelper.getObjectData(typeMatch[2]);
                    var entry = item.name || coyoTrackingUtils.getPageConfig().trackingTitle || '';
                    sendTrackingEvent(type, 'Unlike', entry, item);
                }
            }
        }, {
            urlPattern: /web\/timeline-items/g,
            method: 'POST',
            execute: function(responseUrl, response) {
                var title = '';
                if (response.recipients && response.recipients.length > 0) {
                    var parentType = coyoTrackingUtils.typeNameOverrides(response.recipients[0].typeName);
                    var parentTitle = coyoTrackingDBHelper.buildTrackingTitle(response.recipients[0]);
                    title = parentType + ' >> ' + parentTitle;
                    sendTrackingEvent('timeline-item', 'Create', title, {
                        type: 'timeline-item',
                        author: response.author.slug
                    });
                }
            }
        }, {
            urlPattern: /web\/timeline-items/g,
            method: 'DELETE',
            execute: function(responseUrl, response) {
                var itemMatch = (/\/web\/timeline-items\/([0-9a-fA-F-]*)$/g).exec(responseUrl);
                if (itemMatch && itemMatch.length > 1) {
                    var item = coyoTrackingDBHelper.getObjectData(itemMatch[1]);
                    sendTrackingEvent('timeline-item', 'Delete', item.name, item);
                }
            }
        }, {
            urlPattern: /web\/users\/([a-z0-9-]+)\/presence-status/g,
            method: 'PUT',
            execute: function(responseUrl, response) {
                // get presence status
                var status = (response.state || 'not defined').toLowerCase();
                sendTrackingEvent(status, 'Change Status', '');
            }
        }, {
            urlPattern: /web\/quick-entity-search/g,
            method: 'GET',
            execute: function(responseUrl, response) {
                //quicksearch handling: do not track every response on typing, wait some time and track the last (possible complete) term
                setTimeout(function() {
                    pendingSearch--;
                    if (pendingSearch == 0) {
                        sendSearchEvent(responseUrl, response, true);
                    }
                }, 1000);
            }
        }, {
            urlPattern: /web\/search(?!.*filters=\w)/g,
            method: 'GET',
            execute: function(responseUrl, response) {
                sendSearchEvent(responseUrl, response, false)
            }
        }, {
            urlPattern: /web\/senders\/.*\/documents/g,
            method: 'POST',
            execute: function(responseUrl, response) {
                sendTrackingEvent('Media', 'Upload', response.displayName);
            }
        }, {
            // document/files use nearly the same handler because different widgets and filetypes work with different requests
            // depending on which one gets executed we track the file view and lastFileId prevents double tracking (also for multiple calls when opening modal)
            // examples: 
            // single-file-widget + documents panel
            //  images: first call = /files/ + /documents/, further calls just /documents/
            //  videos: first call = /files/ + /stream/, further calls nothing catchable, sometimes /stream/ based on currently streamed data
            //  other docs: first call = /files/ + further calls nothing catchable
            // media-widget:
            //  images: always /files/, nothing else
            //  videos: always /stream/ HEAD, nothing else
            // embedded video in posts:
            //  no modal, no xhr requests, so we do our own HEAD request to get the title
            urlPattern: /web\/senders\/.*\/documents/g,
            method: 'GET',
            execute: function(responseUrl, response) {
                var docMatch = (/documents\/([0-9a-fA-F-]*)/g).exec(responseUrl);
                var modal = document.querySelector('.modal-dialog');
                if (docMatch && docMatch[1] && modal) {
                    var objData = coyoTrackingDBHelper.getObjectData(docMatch[1]);
                    if (lastFileId !== objData.name) sendTrackingEvent('Media', 'Ansicht', objData.name);
                    lastFileId = objData.name;
                    setTimeout(function() {
                        lastFileId = '';
                    }, 5000);
                }
            }
        },
        {
            urlPattern: /web\/senders\/.*\/files/g,
            method: 'GET',
            execute: function(responseUrl, response, requestData, respHeader) {
                var modal = document.querySelector('.modal-dialog');
                if (modal && response && response.displayName && response.displayName.length) {
                    if (lastFileId !== response.displayName) sendTrackingEvent('Media', 'Ansicht', response.displayName);
                    lastFileId = response.displayName;
                    setTimeout(function() {
                        lastFileId = '';
                    }, 5000);
                }
            }
        },
        {
            urlPattern: /web\/senders\/.*\/stream/g,
            method: 'HEAD',
            execute: function(responseUrl, response, requestData, respHeader) {
                var modal = document.querySelector('.modal-dialog');
                if (modal) {
                    coyoTrackingUtils.getVideoInfo(responseUrl, function(filename) {
                        sendTrackingEvent('Media', 'Ansicht', filename, null)
                    });
                }
            }
        },
        {
            urlPattern: /web\/shares\/(!multiple)/g,
            method: 'POST',
            saveRequestData: true,
            execute: function(responseUrl, response, requestData) {
                var itemID = requestData ? requestData.itemId : '';
                var item = coyoTrackingDBHelper.getObjectData(itemID);
                sendTrackingEvent(item.type, 'Share', item.name, item);
            }
        }, {
            urlPattern: /web\/shares\/multiple\//g,
            method: 'POST',
            saveRequestData: true,
            execute: function(responseUrl, response, requestData) {
                if (!requestData) {
                    return;
                }
                for (var i = 0; i < requestData.length; i++) {
                    var itemID = requestData[i].itemId;
                    var item = coyoTrackingDBHelper.getObjectData(itemID);
                    var share = response[i];
                    if (!share || !share.recipient) {
                        continue;
                    }
                    sendTrackingEvent(item.type, 'Share', item.name, item);
                }
            }
        },
        //     urlPattern: /web\/.*\/(wiki|blog)\/articles/g,
        //     method: 'POST',
        //     execute: function(responseUrl, response) {
        //         var parent = coyoTrackingDBHelper.getObjectData(response.senderId);
        //         var label = coyoTrackingUtils.typeNameOverrides(parent.type) + ' >> ' + parent.name;
        //         sendTrackingEvent(response.typeName, 'Create', label);
        //     }
        // }, {
        // }, {
        //     urlPattern: /web\/events/g,
        //     method: 'POST',
        //     execute: function(responseUrl, response) {
        //         sendTrackingEvent(response.event.typeName, 'Create', coyoTrackingDBHelper.buildTrackingTitle(response.event));
        //     }
        // }, {
        //     urlPattern: /web\/pages/g,
        //     method: 'POST',
        //     execute: function(responseUrl, response) {
        //         sendTrackingEvent(response.typeName, 'Create', coyoTrackingDBHelper.buildTrackingTitle(response));
        //     }
    ];

    function sendTrackingEvent(targetType, action, title, checkUserItem, hasSearchResults) {
        if (coyoTrackingUtils.excludeUser(checkUserItem)) return;

        // check for platform specific type name overrides
        var pageConfig = coyoTrackingUtils.getPageConfig();
        var pageType = pageConfig.contentGroup[1] || null;
        var pageTitle = pageConfig.contentGroup[2] || null;
        var pageTitle = pageConfig.contentGroup[2] || null;
        var appType = pageConfig.contentGroup[3] || null;
        var appTitle = pageConfig.contentGroup[4] || null;

        //handle 'create' for chat vs others like timeline
        if (targetType === 'chat-message' && action === 'Create') action = 'Nachricht senden';
        //handle 'create' for timeline (do not track title)
        if (targetType === 'timeline-item' && action === 'Create') title = '';
        targetType = coyoTrackingUtils.typeNameOverrides(targetType);
        action = coyoTrackingUtils.typeNameOverrides(action);
        coyoTrackingUtils.cleanupCustomDimensions();
        if (pageType) {
            _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETYPE_EVENT, coyoTrackingUtils.typeNameOverrides(pageType)]);
            // _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETYPE_EVENT_VISIT, coyoTrackingUtils.typeNameOverrides(pageType)]);
        }
        if (pageTitle) {
            _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE_EVENT, coyoTrackingUtils.typeNameOverrides(pageTitle)]);
            // _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE_EVENT_VISIT, coyoTrackingUtils.typeNameOverrides(pageTitle)]);
        }
        // prevent tracking apptype 'Show', 
        // this happens either after a new Page/Workspace is created and there is no app setup or if redirects take longer then our debounce allows
        if (appType && appType !== 'show') {
            _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTYPE_EVENT, coyoTrackingUtils.typeNameOverrides(appType)]);
            // _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTYPE_EVENT_VISIT, coyoTrackingUtils.typeNameOverrides(appType)]);
        }
        if (appTitle) {
            _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTITLE_EVENT, coyoTrackingUtils.typeNameOverrides(appTitle)]);
            // _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTITLE_EVENT_VISIT, coyoTrackingUtils.typeNameOverrides(appTitle)]);
        }

        // special search handling
        if (typeof hasSearchResults === 'boolean') {
            _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE_EVENT, (hasSearchResults ? 'Suchergebnis' : 'Kein Suchergebnis')]);
        }
        _paq.push(['trackEvent', targetType, action, title]);
        // _paq.push(['trackEvent', targetType, action, title, null, {
        //     dimension6: pageType, 
        //     dimension7: pageTitle, 
        //     dimension8: appType,
        //     dimension9: appTitle
        // }]);
        coyoTrackingUtils.cleanupCustomDimensions();
    }

    function sendSearchEvent(responseUrl, response, isQuicksearch) {
        var pageConfig = coyoTrackingUtils.getPageConfig();
        var queryParams = coyoTrackingUtils.parseQueryString(responseUrl.replace(/.*\?/i, '?'));
        if (response && queryParams && 'object' === typeof queryParams && 'term' in queryParams && 'object' === typeof queryParams.term) {
            var pageConfig = coyoTrackingUtils.getPageConfig();
            var searchedTerm = queryParams.term.length === 1 ? decodeURIComponent(queryParams.term[0].toString()) : '';
            var rspFoundEleCount = typeof response.totalElements === 'number' ? parseInt(response.totalElements) : false;
            if (pageConfig.contentGroup[1]) {
                _paq.push(['trackSiteSearch', searchedTerm, isQuicksearch ? coyoTrackingUtils.typeNameOverrides('quicksearch') : coyoTrackingUtils.typeNameOverrides('search'), rspFoundEleCount]);
                coyoTrackingUtils.cleanupCustomDimensions();
                if (typeof isQuicksearch !== 'boolean' || !isQuicksearch) {
                    debounce(function() {
                        setTimeout(function() {
                            trackPageView(rspFoundEleCount);
                        }, extanaSettings.delayForStateChange || 2);
                    }, 250)();
                }
            }
        }
        return false;
    }

    function initDownloadListener() {
        // add download tracking for coyo internal files
        window.mtmDownloadListener = window.mtmDownloadListener || setInterval(function() {
            // [].slice.call for IE compatibility
            [].slice.call(document.querySelectorAll('a[coyo-download]:not(.piwik_ignore), a[href^="/web/senders/"][href*="/documents/"]:not(.piwik_ignore)')).forEach(function(elem) {
                elem.classList.add('piwik_ignore');
                if (!coyoTrackingUtils.excludeFromTracking()) {
                    elem.addEventListener('mousedown', function() {
                        function getLink(elem) {
                            var parent = elem.closest('.modal-file-details, .fl-table-row.file');
                            if (parent) {
                                var url = parent.querySelector('coyo-copy-file-link .copy-link a').dataset.clipboardText
                                var linkparts = url.split('/');
                                var filename = decodeURIComponent(linkparts[linkparts.length - 1]);
                                var lastSpace = filename.lastIndexOf(' ');
                                return {
                                    url: url,
                                    filename: filename.substr(0, lastSpace) + '.' + filename.substr(lastSpace + 1)
                                }
                            }

                            // change URL from '/web/senders/*senderID*/documents/*docID*' to '/files/*senderID*/*docID*/*docTitle*' and send it as url param
                            if (/web\/senders\/([a-z0-9-]+)\/documents\/([a-z0-9-]+)/gi.exec(elem.href)) {
                                var url = elem.href.replace('/web/senders/', '/files/').replace('/documents/', '/');
                                url = url.lastIndexOf('/') === url.length - 1 ? url : url + '/';
                                url += encodeURIComponent(elem.innerText.trim());
                                return {
                                    url: url,
                                    filename: elem.innerText.trim()
                                }
                            }

                            if (elem.getAttribute('coyo-download')) {
                                // handle download-widget (content)
                                var child = elem.firstElementChild;
                                var filename = '';
                                if (child.className === 'file-name') {
                                    filename = child.innerText.trim();
                                } else if ((parent = elem.closest('.single-file-widget-details-text')) !== null) {
                                    filename = parent.firstElementChild.innerText.trim();
                                }
                                return {
                                    url: '', // TODO: try to add get the url from somewhere, if required someday...
                                    filename: filename
                                }
                            }
                            return null;
                        }
                        var link = getLink(elem);
                        if (link.filename && link.filename.length) {
                            sendTrackingEvent('Media', 'Download', link.filename);
                            // _paq.push(['trackLink', link, 'download']);
                        }
                    });
                }
            });
        }, 500);
    }

    // debounce function to supress page views being triggered during coyo redirects
    function debounce(func, wait, immediate) {
        var timeout;
        return function() {
            initialStateChangeFired = true;
            var context = this;
            var args = arguments;
            var later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    };

    function trackPageView(searchResults) {
        if (typeof coyoTrackingUtils != "object") {
            console.log("Coyo tracking utils not defined.");
            return;
        }
        var pageConfig = coyoTrackingUtils.getPageConfig();
        var pageId = coyoTrackingUtils.pageIdToString(pageConfig.contentGroup);
        var pageType = pageConfig.contentGroup[1] || null;
        var pageTitle = pageConfig.contentGroup[2] || null;
        var appType = pageConfig.contentGroup[3] || null;
        var appTitle = pageConfig.contentGroup[4] || null;
        var contentTitle = pageConfig.contentGroup[5] || null;
        if (coyoTrackingUtils.excludeFromTracking() || !pageId || pageId.indexOf(window.location.host + '..') == 0) {
            // if(ENV === 'test'){console.log('pageview abort excluded',coyoTrackingUtils.excludeFromTracking(), pageId, pageId.indexOf(window.location.host + '..') );}
            return;
        }
        initDownloadListener();

        // var userCount = coyoTrackingUtils.getRegisteredUsers();
        if (!coyoTrackingUtils.excludeFromTracking(EXCLUDED_GROUPINGPATHS)) {
            if (pageType) {
                _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETYPE, coyoTrackingUtils.typeNameOverrides(pageType)]);
                // _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETYPE_VISIT, coyoTrackingUtils.typeNameOverrides(pageType)]);
            }
            if (pageTitle) {
                _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE, coyoTrackingUtils.typeNameOverrides(pageTitle)]);
                // _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE_VISIT, coyoTrackingUtils.typeNameOverrides(pageTitle)]);
            }
            // prevent tracking apptype 'Show', 
            // this happens either after a new Page/Workspace is created and there is no app setup or if redirects take longer then our debounce allows
            if (appType && appType !== 'show') {
                _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTYPE, coyoTrackingUtils.typeNameOverrides(appType)]);
                // _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTYPE_VISIT, coyoTrackingUtils.typeNameOverrides(appType)]);
            }
            if (appTitle) {
                _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTITLE, coyoTrackingUtils.typeNameOverrides(appTitle)]);
                // _paq.push(['setCustomDimension', CUSTOMDIMENSION_APPTITLE_VISIT, coyoTrackingUtils.typeNameOverrides(appTitle)]);
            }
            if (contentTitle) {
                _paq.push(['setCustomDimension', CUSTOMDIMENSION_CONTENTTITLE, coyoTrackingUtils.typeNameOverrides(contentTitle)]);
                // _paq.push(['setCustomDimension', CUSTOMDIMENSION_CONTENTTITLE_VISIT, coyoTrackingUtils.typeNameOverrides(contentTitle)]);
            }
        }
        _paq.push(['setReferrerUrl', currentUrl]);
        currentUrl = window.location.href;
        _paq.push(['setCustomUrl', currentUrl]);
        _paq.push(['setDocumentTitle', pageId]);
        _paq.push(['setGenerationTimeMs', 0]);

        if (pageType === 'search') {
            if (typeof searchResults !== 'undefined') {
                if (searchResults > 0) {
                    _paq.push(['setDocumentTitle', pageId + '.suchergebnis']);
                    _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE, 'Suchergebnis']);
                } else {
                    _paq.push(['setDocumentTitle', pageId + '.kein-suchergebnis']);
                    _paq.push(['setCustomDimension', CUSTOMDIMENSION_PAGETITLE, 'Kein Suchergebnis']);
                }
            } else {
                // if(ENV === 'test'){console.log('pageview abort search',searchResults);}
                return
            }
        }

        if (extanaSettings.pkContentTracking) {
            var content = jQuery(extanaSettings.pkContentTrackingSelector).get(0);
            if (extanaSettings.pkContentTrackingScanForMedia)
                _paq.push(['MediaAnalytics::scanForMedia', content]);
            if (extanaSettings.pkContentTrackingScanForForms)
                _paq.push(['FormAnalytics::scanForForms', content]);
            if (extanaSettings.pkContentTrackingMode === 'node')
                _paq.push(['trackContentImpressionsWithinNode', content]);
            else if (extanaSettings.pkContentTrackingMode === 'delay')
                _paq.push(['trackVisibleContentImpressions', true, extanaSettings.pkContentTrackingRefreshDelay || 750]);
        }
        if (extanaSettings.pkTrackMiddleRightMouseClick) {
            _paq.push(["enableLinkTracking", true]);
        } else {
            _paq.push(["enableLinkTracking"]);
        }
        // if(ENV === 'test'){console.log('pageview sending',pageConfig );}
        _paq.push(['trackPageView']);
        coyoTrackingUtils.cleanupCustomDimensions();
        // if(ENV === 'test'){console.log('pageview done');}
    }

    // page view tracking
    window.document.addEventListener('stateChangeSuccess', debounce(function() {
        // if(ENV === 'test'){console.log('stateChangeSuccess event');}
        setTimeout(function() {
            trackPageView();
        }, extanaSettings.delayForStateChange || 2);
    }, 1000), false);

    // request event tracking
    var openPrototypeTracking = XMLHttpRequest.prototype.open;
    var sendPrototypeTracking = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.open = function() {
        var method = arguments[0];
        var reqURL = arguments[1];
        var that = this;

        // special case for getting request data from send() method
        coyoRequestTrackingConfig.forEach(function(item) {
            if (method == item.method && reqURL && reqURL.match(item.urlPattern) && item.saveRequestData) {
                that.saveRequestData = true;
            }
        });

        //quicksearch handling: do not track every response on typing, wait some time and track the last (possible complete) term 
        if (reqURL.match(/web\/quick-entity-search/g)) {
            pendingSearch++;
        }

        this.addEventListener('load', function(e) {
            if (coyoTrackingUtils.excludeFromTracking()) {
                return;
            }
            var resp = {};
            var rspPayload = null;
            var reqQueryParams = null;
            resp.responseType = this.responseType;
            resp.responseURL = this.responseURL || reqURL;
            resp.requestData = this.requestData;
            resp.headers = {};
            resp.headers = coyoTrackingUtils.getResponseHeaders(that);
            try {
                resp.responseText = this.responseText;

                rspPayload = e.currentTarget.responseText.length > 0 ? JSON.parse(e.currentTarget.responseText) : null;
                reqQueryParams = coyoTrackingUtils.parseQueryString(reqURL.replace(/.*\?/i, '?'));
            } catch (e) {}
            setTimeout(function() {
                if (typeof coyoTrackingDBHelper == 'undefined') {
                    console.log('Coyo tracking name data base not defined.');
                    return;
                }

                var response;
                try {
                    if ((resp.responseType == '' || resp.responseType == 'text' || resp.responseType == 'document' || resp.responseType == 'moz-chunked-text') && resp.responseText) {
                        response = eval("(" + resp.responseText + ")");
                    }
                } catch (e) {}

                // check all defined listener
                coyoRequestTrackingConfig.forEach(function(item) {
                    if (method == item.method && resp.responseURL.match(item.urlPattern) && typeof item.execute == 'function') {
                        item.execute(resp.responseURL, response, resp.requestData, resp.headers);
                        return;
                    }
                });
            });
        }, 2);
        openPrototypeTracking.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function() {
        try {
            if (arguments && arguments[0] && this.saveRequestData) {
                this.requestData = JSON.parse(arguments[0]);
            }
        } catch (e) {}

        sendPrototypeTracking.apply(this, arguments);
    };

    // fix for using this script with matomo tag manager / container:
    // the container will be loaded async, this results in 2 cases
    // a) the container with this code finished loading BEFORE the app finishes with a stateChangeSuccess -> everything works normal, initial pagewview is catched by the event
    // b) AFTER that -> we missed the first stateChangeSuccess and therefore have to trigger it manually
    if (USE_TAGMANAGER) {
        setTimeout(function() {
            if (!initialStateChangeFired) {
                // if(ENV === 'test'){console.log('initial page call');}
                trackPageView();
                initialStateChangeFired = true;
            }
        }, extanaSettings.delayForStateChange || 2);
    }

    /** ######################## **/
    /* LHM Custom Code PROD
    /* T-Systems MMS
    /* Version: 1.0.1
    /* Updated: 2020-05-15
    /** ######################## **/

    var ignore = 'data-piwikignore';
    var ignoreSelector = ':not([' + ignore + ']';

    //click event tracking
    var coyoClickTracking = {
        filterClickTracking: function(category, item) {
            item.addEventListener('click', function() {
                var name = "";
                item.querySelectorAll('span:not(.badge)').forEach(function(item) {
                    name += item.textContent;
                });
                name = name.trim();
                var hasResults = item.querySelector('span.badge') !== null;
                sendTrackingEvent(category, 'Klick', coyoTrackingUtils.typeNameOverrides(name), null, hasResults);
            });
            item.setAttribute("data-clickevent", "true");
        },

        // the attribute data-title is set by listening to the stream HEAD request in tracking.js
        // if there is no such attribute, this failed because it was not possible to parse a title or match the response with an element
        addVideoTracking: function() {
            document.querySelectorAll('video' + ignoreSelector).forEach(function(item) {
                // if a default uploaded video is embedded in a post, there is no information about the title
                // look into objectDB, otherwise send a HEAD request to the source, parse the title from the header, add the data-title attribute to that video
                // then track it with its title on first play
                item.setAttribute(ignore, "true");
                if (!item.getAttribute('data-title')) {
                    coyoTrackingUtils.getVideoInfo(item.src, function(filename) {
                        item.setAttribute('data-title', filename);
                    });
                }
                item.addEventListener('play', function(e) {
                    var viewed = item.getAttribute('data-viewed');
                    //only track initial video starts
                    if (!viewed) {
                        setTimeout(function() {
                            var title = item.getAttribute('data-title');
                            var modal = document.querySelector('.modal-dialog');
                            if (title && !modal) sendTrackingEvent('Media', 'Ansicht', title, null);
                            item.setAttribute('data-viewed', "true");
                        }, 500);
                    }
                });
                item.setAttribute(ignore, "true");
            });
        },

        addClickBindings: function() {
            // Header Navigation
            document.querySelectorAll(SELECTORS.HEAD_NAVIGATION + ignoreSelector).forEach(function(item) {
                // skip mobile menu button
                if (item.getAttribute('ng-click') === '$ctrl.openMenu()') return true
                item.addEventListener('click', function(e) {
                    var name = 'Navigation';
                    name = item.className === 'nav-item-brand' ? 'Startseite' : item.querySelector('.nav-item-label').textContent.trim();
                    sendTrackingEvent('Header', 'Klick', coyoTrackingUtils.typeNameOverrides(name), null);
                });
                item.setAttribute(ignore, "true");
            });
            // Header Subnavigation
            document.querySelectorAll(SELECTORS.HEAD_SUBNAVIGATION + ignoreSelector).forEach(function(item) {
                item.addEventListener('click', function(e) {
                    var name = 'Navigation';
                    name = item.textContent.trim();
                    sendTrackingEvent('Navi-Top', 'Klick', coyoTrackingUtils.typeNameOverrides(name), null);
                });
                item.setAttribute(ignore, "true");
            });
            // Mobile Sidebar Navigation
            document.querySelectorAll(SELECTORS.NAV_SIDEBAR + ignoreSelector).forEach(function(item) {
                item.addEventListener('click', function(e) {
                    for (var i = 0; i < EXCLUDED_PATHS.length; i++) {
                        if (window.location.href.match(EXCLUDED_PATHS[i])) return;
                    }
                    var name = 'Navigation';
                    name = item.textContent.trim();
                    sendTrackingEvent('Navi-Mobile', 'Klick', coyoTrackingUtils.typeNameOverrides(name), null);
                });
                item.setAttribute(ignore, "true");
            });
            document.querySelectorAll(SELECTORS.SIDEBAR_SUBSCRIPTIONS + ignoreSelector).forEach(function(item) {
                item.addEventListener('click', function() {
                    var type = /\/pages\//gi.exec(item.href) ? 'Widget-Meine-Seiten' : 'Widget-Meine-Arbeitsraeume';
                    var name = item.querySelector('.senderName').textContent.trim();
                    sendTrackingEvent(type, 'Klick', coyoTrackingUtils.typeNameOverrides(name), null);
                });
                item.setAttribute(ignore, "true");
            });
            document.querySelectorAll(SELECTORS.SIDEBAR_BOOKMARKS + ignoreSelector).forEach(function(item) {
                item.addEventListener('click', function() {
                    var name = item.textContent.trim();
                    sendTrackingEvent('Widget-Lesezeichen', 'Klick', coyoTrackingUtils.typeNameOverrides(name), null);
                });
                item.setAttribute(ignore, "true");
            });
            document.querySelectorAll(SELECTORS.SEARCHFILTER_TYPE + ignoreSelector).forEach(function(item) {
                coyoClickTracking.filterClickTracking('Suche-Typ', item);
                item.setAttribute(ignore, "true");
            });
            document.querySelectorAll(SELECTORS.SEARCHFILTER_MODIFIED + ignoreSelector).forEach(function(item) {
                coyoClickTracking.filterClickTracking('Suche-Geaendert', item);
                item.setAttribute(ignore, "true");
            });
            document.querySelectorAll(SELECTORS.SEARCHFILTER_LOCATION + ignoreSelector).forEach(function(item) {
                coyoClickTracking.filterClickTracking('Suche-Ort', item);
                item.setAttribute(ignore, "true");
            });
            document.querySelectorAll(SELECTORS.SEARCHFILTER_AUTHOR + ignoreSelector).forEach(function(item) {
                coyoClickTracking.filterClickTracking('Suche-Autor', item);
                item.setAttribute(ignore, "true");
            });
        }
    }

    // page view tracking
    window.document.addEventListener('stateChangeSuccess', debounce(function() {
        setTimeout(function() {
            coyoClickTracking.addClickBindings();
            coyoClickTracking.addVideoTracking();
        }, extanaSettings.delayForStateChange || 2);
    }, 1000), false);
</script>